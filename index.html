<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LONDON ASH | SURVIVAL FPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { --accent: #d32f2f; --panel: rgba(15, 15, 15, 0.85); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #8899aa; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; }
        canvas { display: block; }

        /* REGION: UI (MENUS + HUD) */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .menu-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: all; }
        .hidden { display: none !important; }
        
        h1 { font-size: 3.5rem; letter-spacing: 5px; color: var(--accent); text-shadow: 2px 2px 0px #000; margin-bottom: 20px; }
        .btn { background: #222; border: 2px solid #444; color: white; padding: 12px 40px; font-size: 1.1rem; cursor: pointer; margin: 5px; width: 280px; text-transform: uppercase; pointer-events: all; }
        .btn:hover { background: var(--accent); border-color: white; }
        
        #hud { position: absolute; inset: 0; pointer-events: none; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.8); transform: translate(-50%, -50%); border-radius: 50%; }
        
        /* Minimap */
        #minimap-container { position: absolute; top: 20px; right: 20px; width: 180px; height: 180px; background: rgba(0,0,0,0.6); border: 3px solid #333; overflow: hidden; }
        #minimap-canvas { width: 100%; height: 100%; }

        .stats-box { background: var(--panel); padding: 15px; border-left: 5px solid var(--accent); width: fit-content; }
        #interact-prompt { position: absolute; bottom: 35%; left: 50%; transform: translateX(-50%); color: #ffeb3b; font-weight: bold; font-size: 1.2rem; text-shadow: 2px 2px 2px #000; }
        #damage-flash { position: absolute; inset: 0; background: rgba(255, 0, 0, 0.2); opacity: 0; pointer-events: none; transition: opacity 0.1s; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="damage-flash"></div>

        <div id="main-menu" class="menu-overlay">
            <h1>LONDON ASH</h1>
            <button class="btn" onclick="game.start()">DEPLOY TO CITY</button>
            <button class="btn" onclick="alert('WASD: Move\nShift: Sprint\nSpace: Jump\nE: Buy\nMouse: Shoot')">CONTROLS</button>
        </div>

        <div id="pause-menu" class="menu-overlay hidden">
            <h1>PAUSED</h1>
            <button class="btn" onclick="game.resume()">RESUME</button>
            <button class="btn" onclick="location.reload()">QUIT</button>
        </div>

        <div id="hud" class="hidden">
            <div id="minimap-container"><canvas id="minimap-canvas"></canvas></div>
            <div id="crosshair"></div>
            <div id="interact-prompt" class="hidden">[E] PURCHASE UPGRADE</div>
            <div class="stats-box">
                <div id="weapon-name">L85 RIFLE</div>
                <div id="ammo-display">30 / 90</div>
                <div style="font-size: 1.5rem; color: #ff5555;">HP: <span id="hp-val">100</span></div>
                <div style="color: #44ff44;">Â£ <span id="pts-val">0</span></div>
            </div>
        </div>
    </div>

<script>
/** * REGION: WORLD GENERATION (LONDON THEME)
 */
function createNoiseTexture(color, noiseColor, size=256) {
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = size;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = color;
    ctx.fillRect(0,0,size,size);
    ctx.fillStyle = noiseColor;
    for(let i=0; i<1000; i++) {
        ctx.globalAlpha = Math.random() * 0.5;
        ctx.fillRect(Math.random()*size, Math.random()*size, 2, 2);
    }
    return new THREE.CanvasTexture(canvas);
}

const TEXTURES = {
    asphalt: createNoiseTexture('#333', '#111'),
    pavement: createNoiseTexture('#777', '#555'),
    brick: createNoiseTexture('#8b4513', '#5d2906'),
    metal: createNoiseTexture('#444', '#666')
};

class City {
    constructor(scene) {
        this.scene = scene;
        this.collidables = [];
        this.shops = [];
        this.init();
    }

    init() {
        // Road System (London style with double yellows)
        const roadGeo = new THREE.PlaneGeometry(20, 200);
        const roadMat = new THREE.MeshStandardMaterial({ map: TEXTURES.asphalt });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        road.receiveShadow = true;
        this.scene.add(road);

        // Pavements
        const pavGeo = new THREE.PlaneGeometry(10, 200);
        const pavMat = new THREE.MeshStandardMaterial({ map: TEXTURES.pavement });
        [-15, 15].forEach(x => {
            const p = new THREE.Mesh(pavGeo, pavMat);
            p.rotation.x = -Math.PI/2;
            p.position.set(x, 0.05, 0);
            p.receiveShadow = true;
            this.scene.add(p);
        });

        // Buildings with "Broken Windows"
        for(let i=0; i<12; i++) {
            const side = i % 2 === 0 ? 1 : -1;
            this.createBuilding(side * 28, 0, (i-6)*30);
        }

        // Debris / Broken Cars (Procedural Blocks)
        for(let i=0; i<8; i++) {
            this.createCar(Math.random()*10 - 5, (Math.random()-0.5)*150);
        }

        // Shop Posts
        this.createShop(12, 0, 10, "SMG MkII", 750);
        this.createShop(-12, 0, -40, "Heavy Rifle", 1500);
    }

    createBuilding(x, y, z) {
        const w = 15, h = 25, d = 20;
        const bGeo = new THREE.BoxGeometry(w, h, d);
        const bMat = new THREE.MeshStandardMaterial({ map: TEXTURES.brick });
        const b = new THREE.Mesh(bGeo, bMat);
        b.position.set(x, h/2, z);
        b.castShadow = true;
        b.receiveShadow = true;
        this.scene.add(b);
        this.collidables.push(b);

        // Windows (Black planes for "broken" look)
        for(let fy=5; fy<h; fy+=6) {
            for(let fz=-d/2+3; fz<d/2; fz+=5) {
                const win = new THREE.Mesh(new THREE.PlaneGeometry(2, 3), new THREE.MeshBasicMaterial({color: 0x000000}));
                win.position.set(x > 0 ? -w/2-0.1 : w/2+0.1, fy, z + fz);
                win.rotation.y = x > 0 ? -Math.PI/2 : Math.PI/2;
                this.scene.add(win);
            }
        }
    }

    createCar(x, z) {
        const car = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({color: 0x551111}));
        body.position.y = 0.6;
        const cabin = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.8, 2), new THREE.MeshStandardMaterial({color: 0x222222}));
        cabin.position.set(0, 1.3, -0.2);
        car.add(body, cabin);
        car.position.set(x, 0, z);
        car.rotation.y = Math.random() * Math.PI;
        this.scene.add(car);
        this.collidables.push(body);
    }

    createShop(x, z, y, name, price) {
        const post = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 3), new THREE.MeshStandardMaterial({color: 0xffcc00}));
        post.position.set(x, 1.5, z);
        this.scene.add(post);
        this.shops.push({ pos: new THREE.Vector3(x, 0, z), name, price });
    }
}

/**
 * REGION: ZOMBIE SYSTEM (Detailed Humans)
 */
class Zombie {
    constructor(scene, player, pos) {
        this.scene = scene;
        this.player = player;
        this.health = 100;
        this.dead = false;
        this.group = new THREE.Group();
        
        const skinMat = new THREE.MeshStandardMaterial({ color: 0x667755 });
        const shirtMat = new THREE.MeshStandardMaterial({ color: 0x334433 });

        // Body parts
        const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), skinMat);
        head.position.y = 1.7;
        
        // Face (Eyes)
        const eye = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.05, 0.05), new THREE.MeshBasicMaterial({color: 0xff0000}));
        eye.position.set(0.1, 1.75, 0.2);
        const eye2 = eye.clone(); eye2.position.x = -0.1;
        head.add(eye, eye2);

        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), shirtMat);
        torso.position.y = 1.1;

        const legL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.7, 0.2), shirtMat);
        legL.position.set(-0.2, 0.35, 0);
        const legR = legL.clone(); legR.position.x = 0.2;

        this.armL = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.7, 0.15), skinMat);
        this.armL.position.set(-0.4, 1.1, 0.2);
        this.armL.rotation.x = -Math.PI/2.5;
        this.armR = this.armL.clone(); this.armR.position.x = 0.4;

        this.group.add(head, torso, legL, legR, this.armL, this.armR);
        this.group.position.copy(pos);
        this.scene.add(this.group);
    }

    takeDamage(dmg) {
        this.health -= dmg;
        if(this.health <= 0) {
            this.dead = true;
            this.scene.remove(this.group);
            return true;
        }
        return false;
    }

    update(delta) {
        if(this.dead) return;
        const dist = this.group.position.distanceTo(this.player.yaw.position);
        if(dist < 25) {
            this.group.lookAt(this.player.yaw.position.x, 0, this.player.yaw.position.z);
            const move = new THREE.Vector3(0,0,1).applyQuaternion(this.group.quaternion).multiplyScalar(0.06 * delta);
            this.group.position.add(move);
            
            // Animation
            this.armL.rotation.x = -Math.PI/2 + Math.sin(Date.now()*0.01)*0.2;
            this.armR.rotation.x = -Math.PI/2 + Math.cos(Date.now()*0.01)*0.2;

            if(dist < 1.5 && Math.random() < 0.05) {
                this.player.health -= 2;
                document.getElementById('damage-flash').style.opacity = 1;
                setTimeout(()=>document.getElementById('damage-flash').style.opacity=0, 50);
            }
        }
    }
}

/**
 * REGION: PLAYER & WEAPON
 */
class Player {
    constructor(scene, camera) {
        this.health = 100;
        this.points = 0;
        this.yaw = new THREE.Object3D();
        this.pitch = new THREE.Object3D();
        this.yaw.add(this.pitch);
        this.pitch.add(camera);
        this.yaw.position.set(0, 1.8, 0);
        scene.add(this.yaw);

        this.velocity = new THREE.Vector3();
        this.move = { f:0, b:0, l:0, r:0 };
        
        // Detailed Gun
        this.gun = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.2, 0.7), new THREE.MeshStandardMaterial({color: 0x222222}));
        const barrel = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 0.5), new THREE.MeshStandardMaterial({color: 0x111111}));
        barrel.rotation.x = Math.PI/2;
        barrel.position.z = -0.4;
        const mag = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.3, 0.15), new THREE.MeshStandardMaterial({color: 0x333333}));
        mag.position.set(0, -0.2, -0.1);
        const scope = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.06, 0.2), new THREE.MeshStandardMaterial({color: 0x111111}));
        scope.position.y = 0.15;
        this.gun.add(body, barrel, mag, scope);
        this.gun.position.set(0.4, -0.3, -0.6);
        this.pitch.add(this.gun);

        this.ray = new THREE.Raycaster();
        this.setupControls();
    }

    setupControls() {
        document.addEventListener('keydown', e => {
            if(e.code==='KeyW') this.move.f=1; if(e.code==='KeyS') this.move.b=1;
            if(e.code==='KeyA') this.move.l=1; if(e.code==='KeyD') this.move.r=1;
            if(e.code==='KeyE') this.interact();
            if(e.code==='Space' && Math.abs(this.velocity.y)<0.01) this.velocity.y = 0.15;
        });
        document.addEventListener('keyup', e => {
            if(e.code==='KeyW') this.move.f=0; if(e.code==='KeyS') this.move.b=0;
            if(e.code==='KeyA') this.move.l=0; if(e.code==='KeyD') this.move.r=0;
        });
        document.addEventListener('mousemove', e => {
            if(document.pointerLockElement) {
                this.yaw.rotation.y -= e.movementX * 0.002;
                this.pitch.rotation.x -= e.movementY * 0.002;
                this.pitch.rotation.x = Math.max(-1.5, Math.min(1.5, this.pitch.rotation.x));
            }
        });
        document.addEventListener('mousedown', () => { if(document.pointerLockElement) this.shoot(); });
    }

    shoot() {
        this.gun.position.z += 0.1;
        this.ray.setFromCamera(new THREE.Vector2(0,0), game.camera);
        const hits = this.ray.intersectObjects(game.zombies.map(z => z.group), true);
        if(hits.length > 0) {
            let target = hits[0].object;
            while(target.parent && !target.zRef) target = target.parent;
            const z = game.zombies.find(z => z.group === target || z.group.children.includes(target));
            if(z && z.takeDamage(34)) this.points += 150;
        }
    }

    interact() {
        game.city.shops.forEach(s => {
            if(this.yaw.position.distanceTo(s.pos) < 4 && this.points >= s.price) {
                this.points -= s.price;
                document.getElementById('weapon-name').innerText = s.name;
            }
        });
    }

    update(delta) {
        const speed = 0.12 * delta;
        const dir = new THREE.Vector3(this.move.r - this.move.l, 0, this.move.b - this.move.f).normalize();
        this.velocity.x = dir.x * speed;
        this.velocity.z = dir.z * speed;
        this.velocity.y -= 0.008 * delta;

        this.yaw.translateX(this.velocity.x);
        this.yaw.translateZ(this.velocity.z);
        this.yaw.position.y += this.velocity.y;

        if(this.yaw.position.y < 1.8) {
            this.yaw.position.y = 1.8;
            this.velocity.y = 0;
        }

        this.gun.position.z += (-0.6 - this.gun.position.z) * 0.2;
        
        document.getElementById('hp-val').innerText = Math.max(0, Math.floor(this.health));
        document.getElementById('pts-val').innerText = this.points;
        if(this.health <= 0) location.reload();
    }
}

/**
 * REGION: MAIN GAME
 */
class Game {
    constructor() {
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x8899aa);
        this.scene.fog = new THREE.Fog(0x8899aa, 10, 150);

        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({antialias:true});
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        document.body.appendChild(this.renderer.domElement);

        const sun = new THREE.DirectionalLight(0xffffff, 1.0);
        sun.position.set(50, 100, 20);
        sun.castShadow = true;
        this.scene.add(sun, new THREE.AmbientLight(0xffffff, 0.4));

        this.city = new City(this.scene);
        this.player = new Player(this.scene, this.camera);
        this.zombies = [];
        this.paused = true;
        this.clock = new THREE.Clock();

        this.miniCanvas = document.getElementById('minimap-canvas');
        this.miniCtx = this.miniCanvas.getContext('2d');
        this.miniCanvas.width = 180; this.miniCanvas.height = 180;

        this.spawn(15);
        this.loop();
    }

    spawn(n) {
        for(let i=0; i<n; i++) {
            this.zombies.push(new Zombie(this.scene, this.player, new THREE.Vector3((Math.random()-0.5)*40, 0, (Math.random()-0.5)*180)));
        }
    }

    start() {
        document.body.requestPointerLock();
        this.paused = false;
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
    }

    resume() {
        document.body.requestPointerLock();
        this.paused = false;
        document.getElementById('pause-menu').classList.add('hidden');
    }

    drawMinimap() {
        const ctx = this.miniCtx;
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,180,180);
        const px = this.player.yaw.position.x;
        const pz = this.player.yaw.position.z;
        
        // Draw shops
        ctx.fillStyle = '#ff0';
        this.city.shops.forEach(s => {
            const mx = 90 + (s.pos.x - px) * 2;
            const mz = 90 + (s.pos.z - pz) * 2;
            ctx.fillRect(mx-2, mz-2, 4, 4);
            ctx.font = '8px Arial';
            ctx.fillText("SHOP", mx+5, mz);
        });

        // Draw Player
        ctx.fillStyle = '#0f0';
        ctx.beginPath(); ctx.arc(90, 90, 3, 0, Math.PI*2); ctx.fill();
    }

    loop() {
        requestAnimationFrame(() => this.loop());
        if(!this.paused) {
            const delta = this.clock.getDelta() * 60;
            this.player.update(delta);
            this.zombies.forEach(z => z.update(delta));
            this.zombies = this.zombies.filter(z => !z.dead);
            if(this.zombies.length < 10) this.spawn(5);
            this.drawMinimap();
            
            // Interaction Check
            let near = false;
            this.city.shops.forEach(s => {
                if(this.player.yaw.position.distanceTo(s.pos) < 4) near = true;
            });
            document.getElementById('interact-prompt').classList.toggle('hidden', !near);
        }
        this.renderer.render(this.scene, this.camera);
    }
}

document.addEventListener('pointerlockchange', () => {
    if(!document.pointerLockElement) {
        game.paused = true;
        document.getElementById('pause-menu').classList.remove('hidden');
    }
});

const game = new Game();
</script>
</body>
</html>
